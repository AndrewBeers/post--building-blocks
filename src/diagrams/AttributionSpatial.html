<:Window bind:innerWidth="winWidth" bind:scrollY="scrollY" />

<div ref:container class="base-grid">

  {{#if attr_data && $labels}}
  <div class="legend l-page">
    <div>
      <p>Input Image</p>
      <div style="position: relative;">
        <img class="input_image" src="examples/input_images/{{$example}}.png" />
        {{#if layer_hover && layer_hover !== 'output'}}
          <div style="position: absolute; background: rgba(255, 255, 255, 0.5); 
            width: {{150/layer_hover_size}}px; height: {{150/layer_hover_size}}px;
            left: {{pos_snap[layer_hover][0] * 150 / layer_hover_size}}px;
            top:  {{pos_snap[layer_hover][1] * 150 / layer_hover_size}}px;"></div>
        {{/if}}

        <ExamplePicker />
      </div>
    </div>

    <ul class="factors_1 attribution_list" on:mouseout="set({layer_hover: undefined, pos_hover: undefined})">
      <li on:mouseover="set({layer_hover: undefined, pos_hover: undefined})">Factors</li>
      {{#if attr_data}}
        {{#each attr_data.nmf[0].slice(0, 5) as attr, i}}
        <li on:mouseover="set({layer_hover: 'nmf', pos_hover: [0, i]})">
          <span>{{$labels[attr.n]}}</span>
          <div class="scent">
            <div style="width: {{100 * (attr.v/attr_data.max.nmf[0])}}%;"></div>
          </div>
        </li>
        {{/each}}
      {{/if}}
    </ul>

    <ul class="factors_2 attribution_list" on:mouseout="set({layer_hover: undefined, pos_hover: undefined})">
      <li on:mouseover="set({layer_hover: undefined, pos_hover: undefined})" style="color: transparent;">Factors</li>
      {{#if attr_data}}
        {{#each attr_data.nmf[1].slice(0, 5) as attr, i}}
        <li on:mouseover="set({layer_hover: 'nmf', pos_hover: [1, i]})">
          <span>{{$labels[attr.n]}}</span>
          <div class="scent">
            <div style="width: {{100 * (attr.v/attr_data.max.nmf[1])}}%;"></div>
          </div>
        </li>
        {{/each}}
      {{/if}}
    </ul>

    <ul class="output_classes attribution_list" on:mouseout="set({layer_hover: undefined, pos_hover: undefined})">
      <li on:mouseover="set({layer_hover: undefined, pos_hover: undefined})">Output Classes</li>
      {{#if output_attr}}
        {{#each output_attr.slice(0, 5) as attr, i}}
        <li on:mouseover="set({layer_hover: 'output', pos_hover: [0, i]})">
          <span>{{$labels[attr.n]}}</span>
          <div class="scent">
            <div style="width: {{100 * (attr.v/attr_max)}}%;"></div>
          </div>
        </li>
        {{/each}}
      {{/if}}
    </ul>
  </div>

  <div class="hidden_layers base-grid" style="display: flex; --layer-size: {{layer_size}}px;">
    {{#each hidden_layers as layer}}
      <ActivationGrid example={{$example}} magnitude={{!layer_hover || layer_hover == layer}} 
        layer={{layer}} layer_size={{layer_size}} show_zoom={{layer_hover == layer}}>

        <div slot="background">
          <img src="examples/attributions/{{$example}}/{{layer}}-nmf.png" style="opacity: {{layer_hover && layer_hover !== layer ? 0 : 0.6}};" />
        </div>

        <div slot="foreground">
          {{#if layer_hover && layer_hover !== layer}}
          <Sprite bg_img="examples/attributions/{{$example}}/{{layer_hover}}-{{layer}}.png" 
            sprite_size={{all_layers[layer][0]}} size={{layer_size}}
            x={{layer_hover && pos_snap[layer_hover][0]}} 
            y={{layer_hover && pos_snap[layer_hover][1]}}></Sprite>
          {{/if}}
        </div>
      </ActivationGrid>
    {{/each}}
  </div>
  {{/if}}
</div>


<figcaption class="l-page">
  Bringing together three building blocks: magnitude-sized activation grids, a heatmap depiction of dimensionality reduction techniques computed on the attribution vectors, and (on hover) saliency maps for attribution between hidden layers.
</figcaption>

<style>
  .hidden_layers {
    position: relative;
    overflow-x: auto;
    overflow-y: hidden;
  }

  .layer img { 
    position: absolute; 
    mix-blend-mode: multiply;
    image-rendering: optimizeSpeed;             /* STOP SMOOTHING, GIVE ME SPEED  */
    image-rendering: -moz-crisp-edges;          /* Firefox                        */
    image-rendering: -o-crisp-edges;            /* Opera                          */
    image-rendering: -webkit-optimize-contrast; /* Chrome (and eventually Safari) */
    image-rendering: pixelated; /* Chrome */
    image-rendering: optimize-contrast;         /* CSS3 Proposed                  */
    -ms-interpolation-mode: nearest-neighbor;   /* IE8+                           */    
  }

  .layer p {
    margin-top: calc(var(--layer-size) + 10px);
  }

  div[slot='foreground'] .outer {
    position: absolute;
    pointer-events: none;
    mix-blend-mode: multiply;
    image-rendering: optimizeSpeed;             /* STOP SMOOTHING, GIVE ME SPEED  */
    image-rendering: -moz-crisp-edges;          /* Firefox                        */
    image-rendering: -o-crisp-edges;            /* Opera                          */
    image-rendering: -webkit-optimize-contrast; /* Chrome (and eventually Safari) */
    image-rendering: pixelated; /* Chrome */
    image-rendering: optimize-contrast;         /* CSS3 Proposed                  */
    -ms-interpolation-mode: nearest-neighbor;   /* IE8+                           */
    opacity: 0.9;
  }

  .legend {
    display: flex;
    margin-bottom: 20px;
  }

  .input_image {
    height: 150px;
    width: auto;
    margin-right: 140px;
    border-radius: var(--border-radius);
  }

  .example_picker {
    position: absolute;
    top: 0;
    right: 20px;
    width: 110px;
    line-height: 1;
  }

  .example_picker img { 
    width: 40px;
    margin: 2px; 
  }

  p.heading, .legend p, .attribution_list li:first-child {
    font-size: 90%;
    font-weight: bold;
    margin: 0 0 15px 0;
  }

  .attribution_list li:not(:first-child) {
    cursor: pointer;
  }

  .attribution_list li:not(:first-child):hover {
    font-weight: bold;
  }

  .output_classes {
    margin-left: 50px;
  }
 
  .output_classes li:hover .scent div { background: #666; }

  .factors_1 .scent div { background: #f4a582; }
  .factors_1 li:hover .scent div { background: #e66101; }

  .factors_2 .scent div { background: #92c5de; }
  .factors_2 li:hover .scent div { background: #0571b0; }
</style>

<script>
  import {json as loadJSON} from 'd3-request';

  import ExamplePicker from './ExamplePicker.html';
  import Sprite from './Sprite.html';
  import ActivationGrid from './ActivationGrid.html';

  import {calc_layer_size, range} from '../util';
  const layers = require('../../static/examples').layers;

  export default {
    data() {
      return {
        all_layers: layers,
        hidden_layers: ['mixed3a', 'mixed4a', 'mixed4d', 'mixed5a']
      }
    },

    oncreate() {
      this.store.observe('example', (example) => {
        loadJSON(`examples/attributions/${example}/spatial_attr.json`, (err, attr_data) => {
          this.set({attr_data, layer_size: calc_layer_size(this.refs.container, 4)});
        });
      });
    },

    computed: {
      layer_hover: ($ag_layer_hover) => $ag_layer_hover,
      pos_hover: ($ag_pos_hover) => $ag_pos_hover,

      layer_size(winWidth, num_layer_width) {
        return calc_layer_size(document.querySelector('#AttributionSpatial .hidden_layers'), 4);
      },

      pos_snap(hidden_layers, layer_size, pos_hover) {
        let snap = hidden_layers.reduce((obj, layer) => {
          obj[layer] = !pos_hover ? [0, 0] : [
            Math.floor(layers[layer][0] * pos_hover[0] / layer_size),
            Math.floor(layers[layer][0] * pos_hover[1] / layer_size)
          ];
          return obj;
        }, {});
        snap.output = snap.nmf = pos_hover;
        return snap;
      },

      valid_layer_hover(layer_hover) {
        return layer_hover && layer_hover.match('mixed') !== null;
      },

      layer_hover_size(all_layers, valid_layer_hover, layer_hover) {
        return valid_layer_hover ? all_layers[layer_hover][0] : 0;
      },

      output_attr(attr_data, valid_layer_hover, layer_hover, pos_snap) {
        try {
          const ps = pos_snap[layer_hover];
          return attr_data.layers[layer_hover][ps[1]][ps[0]]; 
        } catch(e) {
          return attr_data ? attr_data.output : null;
        }
      },

      attr_max(attr_data, valid_layer_hover, layer_hover) {
        if (!attr_data) return null;
        return attr_data.max[valid_layer_hover ? layer_hover : 'output'];
      },
    },

    components: {ActivationGrid, ExamplePicker, Sprite}
  }
</script>