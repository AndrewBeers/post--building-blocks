<:Window bind:scrollY="scrollY"
  on:mouseup="set({downX: undefined})" on:mousemove="drag(event)" />

<div class="layers_container" 
  style="--img-size: {{img_size}}px; 
  --mask-width: {{mask_width}}px; 
  --mask-height: {{mask_height}}px;">

  <div class="layer">
    <div class="mask input_img" 
      on:mousedown="set({downX: event.pageX, downLeft: left})">
        <img style="margin-left: {{left}}px;" src="examples/{{example}}.png" draggable={{false}} />
    </div>

    <p>Input Image</p>
  </div>

  {{#each Object.keys(layers) as lname}}
    <div class="layer">
      <div class="mask" 
        on:mousemove="hover_sprite(event, this.getBoundingClientRect())"
        on:mouseout="set({pos: pos_init})">
          <img style="margin-left: {{left}}px;" src="examples/{{example}}_{{lname}}.jpeg" />
      </div>

      <div class="sprite_container" 
        style="left: {{pos[0]+10}}px; top: {{pos[1]+10}}px; opacity: {{downX ? 0 : 1}}">
        <Sprite bg_img="examples/{{example}}_{{lname}}.jpeg" 
          size="74" sprite_size="{{layers[lname][1]}}"
          x="{{snap_x_panned[lname]}}" 
          y="{{snap_y[lname]}}"></Sprite>
      </div>

      <p>{{lname}}</p>
    </div>
  {{/each}}
</div>

<style>
  .layers_container { 
    display: flex;
    width: 900px; 
    margin-bottom: 36px;
  }

  .layer {
    position: relative;
    width: 150px;
    height: var(--mask-height);
    margin-right: 15px;
  }

  .mask {
    height: 100%;
    overflow: hidden;
  }

  .mask img {
    width: auto;
    height: 100%;
  }

  .input_img {
    cursor: move;
  }

  .brush {
    position: absolute;
    top: 0;
    width: var(--mask-width);
    height: 100%;
    background: rgba(236, 217, 133, 0.4);
    cursor: move;    
  }

  .layer p {
    margin-top: 5px;
    color: #666;
    font-size: 90%;
  }

  .input_img p { margin-top: 0px; }

  .sprite_container {
    position: absolute;
    padding: 5px;
    background: rgba(255, 255, 255, 0.9);
    border: 1px solid #ccc;
    z-index: 100;
    transition: opacity .25s ease-in-out;
  }
</style>

<script>
  import Sprite from './Sprite.html'
  import {range} from '../util';
  const examples = require('../../static/examples');
  const MASK_WIDTH = 140, MASK_HEIGHT = 320;
  const POS_INIT = [60, MASK_HEIGHT - 50]

  function clamp(x, min, max) {
    return Math.min(Math.max(x, min), max);
  }

  export default {
    data() {
      return {
        example: undefined,
        layers: examples.layers,
        img_size: examples.input_size,
        mask_width: MASK_WIDTH,
        mask_height: MASK_HEIGHT,
        left: 0,
        pos: POS_INIT,
        pos_init: POS_INIT
      };
    },

    computed: {
      snap_x (pos, layers) {
        return Object.keys(layers).reduce((coords, lname) => {
          coords[lname] = Math.floor(layers[lname][0] * pos[0] / MASK_HEIGHT);
          return coords;
        }, {});     
      },

      snap_x_panned (pos, left, layers) {
        return Object.keys(layers).reduce((coords, lname) => {
          coords[lname] = Math.floor(layers[lname][0] * (pos[0] + Math.abs(left)) / MASK_HEIGHT);
          return coords;
        }, {});       
      },

      snap_y (pos, layers) {
        return Object.keys(layers).reduce((coords, lname) => {
          coords[lname] = Math.floor(layers[lname][0] * pos[1] / MASK_HEIGHT);
          return coords;
        }, {});
      } 
    },

    methods: {
      drag (event) {
        const downX = this.get('downX');
        if (downX === undefined) return;

        const delta = event.pageX - downX;
        let left = this.get('downLeft') || 0;
        left = clamp(left + delta, -(examples.input_size - MASK_WIDTH), 0);
        this.set({left});
      },

      hover_sprite (event, bb) {
        const x = bb.left, y = bb.top + this.get('scrollY');
        this.set({ pos: [event.pageX - x, event.pageY - y] });
      }
    },
    

    components: { Sprite },
    helpers: { 
      range, clamp
    }
  }
</script>